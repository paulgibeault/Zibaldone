#!/bin/bash

# Source modular scripts
source scripts/common.sh
source scripts/config.sh
source scripts/deps/python.sh
source scripts/deps/node.sh
source scripts/deps/docker.sh
source scripts/deps/minio.sh
source scripts/deps/litellm.sh

load_config

FULL_CLEANUP=false
FORCE=false

# Argument parsing
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --full) FULL_CLEANUP=true ;;
        -y|--force) FORCE=true ;;
        *) log_error "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

log_info "=== Zibaldone Cleanup ($ZIB_MODE Mode) ==="
[ "$FULL_CLEANUP" = true ] && log_warning "FULL cleanup requested. This will delete data and uninstall system dependencies."

if [ "$FORCE" = false ]; then
    read -p "Are you sure you want to proceed? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cleanup cancelled."
        exit 0
    fi
fi

# 1. Component Cleanup
cleanup_python "$FULL_CLEANUP"
cleanup_node "$FULL_CLEANUP"
cleanup_litellm
cleanup_minio "$FULL_CLEANUP"
cleanup_docker "$FULL_CLEANUP"

# 2. Config & Data Removal
log_info "\nCleaning configuration..."
rm -f .zibaldone.conf
rm -f backend/.env
rm -f litellm_config.yaml

if [ "$FULL_CLEANUP" = true ]; then
    log_info "Removing data directory..."
    rm -rf data
    
    # Homebrew uninstallation
    if command_exists brew; then
        if [ "$ZIB_MODE" = "local" ]; then
             log_info "Homebrew dependency removal handled by components."
        fi
    fi
fi

log_success "Cleanup complete."
