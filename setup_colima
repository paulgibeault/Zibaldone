#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== Zibaldone Container Setup (via Colima) ===${NC}"

# 1. Check Homebrew
echo -e "\n${BLUE}[1/4] Checking Homebrew...${NC}"
if ! command -v brew &> /dev/null; then
    echo -e "${RED}Error: Homebrew not found.${NC}"
    echo -e "${YELLOW}Please install Homebrew from https://brew.sh/${NC}"
    exit 1
else
    echo -e "${GREEN}✓ Homebrew found.${NC}"
fi

# 2. Install Colima & Docker CLI
echo -e "\n${BLUE}[2/4] Checking Colima & Docker...${NC}"

if ! command -v colima &> /dev/null; then
    echo -e "${YELLOW}Colima not found. Installing via Homebrew...${NC}"
    brew install colima docker docker-compose
    echo -e "${GREEN}✓ Colima installed.${NC}"
else
    echo -e "${GREEN}✓ Colima found.${NC}"
fi

# Ensure docker CLI is present (needed to talk to Colima)
if ! command -v docker &> /dev/null; then
     echo -e "${YELLOW}Docker CLI not found. Installing...${NC}"
     brew install docker
fi

# 3. Start Colima
echo -e "\n${BLUE}[3/4] Checking Colima Status...${NC}"

# Function to check if daemon is responsive via docker cli
check_daemon() {
    docker info &> /dev/null
    return $?
}

if ! check_daemon; then
    echo -e "${YELLOW}Docker daemon is not reachable.${NC}"
    echo -e "${BLUE}Starting Colima...${NC}"
    
    colima start
    
    if check_daemon; then
        echo -e "${GREEN}✓ Colima is running and Docker is reachable.${NC}"
    else
        echo -e "${RED}Error: Colima started but Docker is still not reachable.${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}✓ Docker Daemon (Colima) is active.${NC}"
fi

# 4. Final Check
echo -e "\n${BLUE}[4/4] Verifying Configuration...${NC}"

if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
     echo -e "${GREEN}✓ docker-compose is available.${NC}"
else
    echo -e "${RED}Error: docker-compose not found.${NC}"
fi

# Check for config
if [ ! -f "litellm_config.yaml" ]; then
    echo -e "${YELLOW}Warning: litellm_config.yaml not found.${NC}"
    echo -e "Running ./setup to generate configuration..."
    ./setup
else
    echo -e "${GREEN}✓ litellm_config.yaml found.${NC}"
fi

echo -e "\n${GREEN}=== Setup Complete! ===${NC}"
echo -e "You can now run: ${BLUE}docker-compose up --build${NC}"
